{% extends "layout.html" %}
{% set active_page = 'dashboard' %}

{% block title %}Dashboard - Testum{% endblock %}

{% block extra_styles %}
    <style>
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .card-icon {
            font-size: 2.5em;
            margin-bottom: 12px;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .stat-card {
            flex: 1;
            min-width: 200px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            color: var(--accent-primary);
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-tertiary);
            font-size: 0.9em;
        }

        .platforms-section {
            margin-top: 40px;
        }

        .platforms-header {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .platforms-link {
            font-size: 0.9em;
            color: var(--accent-primary);
        }

        .platforms-list {
            display: grid;
            gap: 15px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1 class="page-title" data-i18n="dashboard">Dashboard</h1>
        <p class="page-subtitle" data-i18n="welcomeDescription">Execute commands and code on remote hosts via SSH</p>
    </div>

    <div class="cards-grid">
        <a href="/keys">
            <div class="card">
                <div class="card-icon">üîë</div>
                <div class="card-title" data-i18n="sshKeysCard">SSH Keys</div>
                <div class="card-description" data-i18n="sshKeysDescription">
                    Manage SSH public keys for secure authentication
                </div>
            </div>
        </a>

        <a href="/platforms">
            <div class="card">
                <div class="card-icon">üñ•Ô∏è</div>
                <div class="card-title" data-i18n="platformsCard">Platforms</div>
                <div class="card-description" data-i18n="platformsDescription">
                    Configure and manage remote platforms (hosts)
                </div>
            </div>
        </a>

        <a href="/health">
            <div class="card">
                <div class="card-icon">‚ö°</div>
                <div class="card-title" data-i18n="healthCheckCard">System Status</div>
                <div class="card-description" data-i18n="healthCheckDescription">
                    Monitor system health and performance
                </div>
            </div>
        </a>

        <a href="/jobs">
            <div class="card">
                <div class="card-icon">üì¶</div>
                <div class="card-title">Jobs</div>
                <div class="card-description">
                    –ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è (Task Monitor)
                </div>
            </div>
        </a>
    </div>

    <div class="stats">
        <div class="stat-card">
            <div class="stat-value">‚Äî</div>
            <div class="stat-label" data-i18n="totalKeys">SSH Keys</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">‚Äî</div>
            <div class="stat-label" data-i18n="totalPlatforms">Platforms</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">‚Äî</div>
            <div class="stat-label" data-i18n="activeTasks">Active Tasks</div>
        </div>
    </div>

    <div class="platforms-section">
        <h2 class="platforms-header">
            <span data-i18n="connectedPlatforms">Connected Platforms</span>
            <a class="platforms-link" href="/platforms">
                <span data-i18n="viewAll">View All</span> ‚Üí
            </a>
        </h2>
        <div id="platformsList" class="platforms-list"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // Load dashboard statistics
        async function loadStats() {
            try {
                // Load platforms count and list
                const platformsResponse = await fetch('/api/platforms/');
                if (platformsResponse.ok) {
                    const platforms = await platformsResponse.json();
                    document.querySelectorAll('.stat-card')[1].querySelector('.stat-value').textContent = platforms.length;
                    renderPlatforms(platforms);
                }

                // Load SSH keys count
                const keysResponse = await fetch('/api/keys/');
                if (keysResponse.ok) {
                    const keys = await keysResponse.json();
                    document.querySelectorAll('.stat-card')[0].querySelector('.stat-value').textContent = keys.length;
                }

                // Active tasks - count running from recent list
                try {
                    const tasksResp = await fetch('/api/tasks/?limit=100');
                    if (tasksResp.ok) {
                        const tasks = await tasksResp.json();
                        const active = tasks.filter(t => t.status === 'running').length;
                        document.querySelectorAll('.stat-card')[2].querySelector('.stat-value').textContent = String(active);
                    }
                } catch (_) {
                    document.querySelectorAll('.stat-card')[2].querySelector('.stat-value').textContent = '‚Äî';
                }

            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Render platforms list
        async function renderPlatforms(platforms) {
            const container = document.getElementById('platformsList');

            if (platforms.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 10px;">üñ•Ô∏è</div>
                        <div data-i18n="noPlatforms">No platforms configured yet</div>
                        <a href="/platforms" style="color: var(--accent-primary); text-decoration: none; margin-top: 10px; display: inline-block;">
                            <span data-i18n="addFirstPlatform">Add your first platform</span> ‚Üí
                        </a>
                    </div>
                `;
                return;
            }

            // Show platforms first, then load info asynchronously
            container.innerHTML = platforms.slice(0, 5).map(p => `
                <div id="platform-${p.id}" style="background: var(--bg-secondary); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                        <div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 5px;">${p.name}</div>
                            <div style="color: var(--text-secondary); font-size: 14px;">${p.host}:${p.port}</div>
                        </div>
                        <div style="background: var(--accent-primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px;">
                            ${p.auth_method === 'password' ? 'üîë Password' : 'üîê SSH Key'}
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-top: 15px; font-size: 13px;">
                        <div>
                            <div style="color: var(--text-secondary);">Username</div>
                            <div style="font-weight: 500;">${p.username}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary);">Status</div>
                            <div id="status-${p.id}" style="color: var(--text-secondary);">‚è≥ Loading...</div>
                        </div>
                    </div>
                    <div id="info-${p.id}" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color); font-size: 12px; display: none;">
                        <!-- System info will be loaded here -->
                    </div>
                </div>
            `).join('');

            // Load system info for each platform
            platforms.slice(0, 5).forEach(async (p) => {
                try {
                    const response = await fetch(`/api/platforms/${p.id}/info`);
                    if (response.ok) {
                        const info = await response.json();
                        updatePlatformInfo(p.id, info);
                    } else {
                        document.getElementById(`status-${p.id}`).innerHTML = '<span style="color: var(--error-text);">‚óè Offline</span>';
                    }
                } catch (error) {
                    document.getElementById(`status-${p.id}`).innerHTML = '<span style="color: var(--error-text);">‚óè Error</span>';
                }
            });
        }

        function updatePlatformInfo(platformId, info) {
            const statusEl = document.getElementById(`status-${platformId}`);
            const infoEl = document.getElementById(`info-${platformId}`);

            if (info.status === 'online') {
                statusEl.innerHTML = '<span style="color: var(--success-text); font-weight: 500;">‚óè Online</span>';

                // Parse OS info
                let osName = 'Unknown OS';
                if (info.os_release) {
                    const match = info.os_release.match(/PRETTY_NAME="([^"]+)"/);
                    if (match) osName = match[1];
                    else osName = info.os_release.split('\n')[0];
                }

                infoEl.style.display = 'grid';
                infoEl.style.gridTemplateColumns = 'repeat(auto-fit, minmax(200px, 1fr))';
                infoEl.style.gap = '10px';
                infoEl.innerHTML = `
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 3px;">OS</div>
                        <div style="font-weight: 500;">${osName}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 3px;">Kernel</div>
                        <div style="font-weight: 500;">${info.kernel || 'N/A'}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 3px;">CPU</div>
                        <div style="font-weight: 500;">${info.cpu || 'N/A'}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 3px;">Memory</div>
                        <div style="font-weight: 500;">${info.memory || 'N/A'}</div>
                    </div>
                    <div>
                        <div style="color: var(--text-secondary); margin-bottom: 3px;">Disk</div>
                        <div style="font-weight: 500;">${info.disk || 'N/A'}</div>
                    </div>
                `;
            } else {
                statusEl.innerHTML = '<span style="color: var(--warning-text); font-weight: 500;">‚óè Offline</span>';
                infoEl.style.display = 'none';
            }
        }

        loadStats();
    </script>
{% endblock %}
