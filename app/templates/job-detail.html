<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Job Details - Testum</title>
    <link rel="stylesheet" href="/static/theme.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        a { text-decoration: none; }
        .header { background: var(--bg-secondary); padding: 15px 30px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); }
        .logo { font-size: 1.4em; font-weight: 600; color: var(--accent-primary); }
        .version { background: var(--bg-tertiary); padding: 4px 10px; border-radius: 8px; font-size: 0.75em; color: var(--text-secondary); }
        .header-right { display: flex; gap: 12px; align-items: center; }
        .logout-btn { background: var(--button-logout); color: var(--bg-primary); padding: 8px 14px; border-radius: 6px; font-size: 0.85em; font-weight: 600; display: flex; gap: 6px; align-items: center; }
        .logout-btn:hover { background: var(--button-logout-hover); }
        .main-layout { display: flex; min-height: calc(100vh - 60px); }
        .sidebar { width: 240px; background: #181825; border-right: 1px solid #313244; padding: 20px 0; }
        .sidebar-section { margin-bottom: 20px; }
        .sidebar-title { color: #6c7086; font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; padding: 0 20px; margin-bottom: 10px; font-weight: 600; }
        .sidebar-link { display: flex; align-items: center; gap: 12px; padding: 12px 20px; color: #cdd6f4; text-decoration: none; transition: all 0.2s; font-size: 0.95em; }
        .sidebar-link:hover { background: #313244; color: #89b4fa; }
        .sidebar-link.active { background: #313244; color: #89b4fa; border-left: 3px solid #89b4fa; }
        .sidebar-icon { font-size: 1.2em; width: 24px; text-align: center; }
        .content { flex: 1; padding: 30px; }
        .back-link { color: var(--accent-primary); font-size: 0.85em; display: inline-block; margin-bottom: 15px; }
        .back-link:hover { text-decoration: underline; }
        h1 { margin-bottom: 5px; display: flex; align-items: center; gap: 12px; }
        .subtitle { color: var(--text-secondary); margin-bottom: 25px; font-size: 0.9em; }
        .status-chip { padding: 6px 14px; border-radius: 16px; font-size: 0.8em; font-weight: 600; display: inline-block; }
        .pending { background: #2d2616; color: #fab387; }
        .running { background: #162d3b; color: #89b4fa; }
        .success { background: #1e2d28; color: #a6e3a1; }
        .failed { background: #2d1e22; color: #f38ba8; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .card h2 { margin-bottom: 15px; font-size: 1.1em; color: var(--text-primary); }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .info-label { color: var(--text-secondary); font-size: 0.8em; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .info-value { color: var(--text-primary); font-size: 0.95em; font-weight: 500; }
        .info-value code { background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; font-size: 0.85em; color: var(--accent-primary); }
        .output-box { background: #181825; border: 1px solid #313244; border-radius: 6px; padding: 15px; font-family: 'Courier New', monospace; font-size: 0.85em; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; }
        .output-box.stdout { color: #a6e3a1; }
        .output-box.stderr { color: #f38ba8; }
        .output-box.empty { color: var(--text-secondary); font-style: italic; text-align: center; padding: 30px; }
        .actions { display: flex; gap: 10px; margin-top: 15px; }
        .btn { background: var(--accent-primary); color: #fff; padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.85em; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
        .btn:hover { opacity: 0.9; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .metadata { background: var(--bg-tertiary); padding: 12px; border-radius: 6px; font-family: monospace; font-size: 0.8em; }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üîê Testum</div>
        <div class="header-right">
            <span class="version">v0.1.0</span>
            <a href="/api/auth/logout" class="logout-btn"><span>üö™</span> Logout</a>
        </div>
    </div>
    
    <div class="main-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Resources</div>
                <a href="/" class="sidebar-link">
                    <span class="sidebar-icon">üè†</span>
                    <span>Dashboard</span>
                </a>
                <a href="/keys" class="sidebar-link">
                    <span class="sidebar-icon">üîë</span>
                    <span>SSH Keys</span>
                </a>
                <a href="/platforms" class="sidebar-link">
                    <span class="sidebar-icon">üñ•Ô∏è</span>
                    <span>Platforms</span>
                </a>
                <a href="/jobs" class="sidebar-link active">
                    <span class="sidebar-icon">üì¶</span>
                    <span>Jobs</span>
                </a>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">System</div>
                <a href="/settings" class="sidebar-link">
                    <span class="sidebar-icon">‚öôÔ∏è</span>
                    <span>Settings</span>
                </a>
                <a href="/health" class="sidebar-link">
                    <span class="sidebar-icon">‚ù§Ô∏è</span>
                    <span>Health Check</span>
                </a>
                <a href="/docs" class="sidebar-link">
                    <span class="sidebar-icon">üìö</span>
                    <span>API Docs</span>
                </a>
            </div>
        </div>
        
        <!-- Content -->
        <div class="content">
            <a href="/jobs" class="back-link">‚Üê Back to Jobs</a>
            <h1>
                <span id="taskIcon">üì¶</span>
                <span>Job Details</span>
                <span class="status-chip pending" id="statusBadge">Loading...</span>
            </h1>
            <div class="subtitle" id="taskIdDisplay">Task ID: <code>{{ task_id }}</code></div>
            
            <!-- Overview Card -->
            <div class="card">
                <h2>üìä Overview</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Task ID</div>
                        <div class="info-value"><code id="taskId">{{ task_id }}</code></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Celery Task ID</div>
                        <div class="info-value"><code id="celeryTaskId">‚Äî</code></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Type</div>
                        <div class="info-value" id="taskType">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Platform</div>
                        <div class="info-value" id="platformName">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Started At</div>
                        <div class="info-value" id="startedAt">‚Äî</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Finished At</div>
                        <div class="info-value" id="finishedAt">‚Äî</div>
                    </div>
                </div>
            </div>
            
            <!-- Metadata Card -->
            <div class="card" id="metadataCard" style="display: none;">
                <h2>üîß Metadata</h2>
                <div class="metadata" id="metadataContent"></div>
            </div>
            
            <!-- Output Card -->
            <div class="card" id="outputCard" style="display: none;">
                <h2>üìù Output</h2>
                <h3 style="font-size: 0.9em; margin-bottom: 8px; color: var(--text-secondary);">STDOUT:</h3>
                <div class="output-box stdout" id="stdoutContent">
                    <div class="empty">No output</div>
                </div>
                
                <h3 style="font-size: 0.9em; margin: 20px 0 8px; color: var(--text-secondary);">STDERR:</h3>
                <div class="output-box stderr" id="stderrContent">
                    <div class="empty">No errors</div>
                </div>
            </div>
            
            <!-- Error Card -->
            <div class="card" id="errorCard" style="display: none;">
                <h2>‚ùå Error</h2>
                <div class="output-box stderr" id="errorContent"></div>
            </div>
            
            <!-- Actions -->
            <div class="actions">
                <a href="/tasks/{{ task_id }}" class="btn" target="_blank">
                    üîç Live Monitor
                </a>
                <button class="btn btn-secondary" onclick="location.reload()">
                    üîÑ Refresh
                </button>
            </div>
        </div>
    </div>

    <script>
        const taskId = '{{ task_id }}';
        
        async function loadJobDetails() {
            try {
                const resp = await fetch(`/api/tasks/${taskId}`);
                if (!resp.ok) {
                    throw new Error('Task not found');
                }
                const data = await resp.json();
                
                // Update status badge
                const statusBadge = document.getElementById('statusBadge');
                statusBadge.textContent = data.status.toUpperCase();
                statusBadge.className = `status-chip ${data.status}`;
                
                // Update icon based on type
                const icons = {
                    'deploy': 'üöÄ',
                    'run_command': '‚ö°'
                };
                document.getElementById('taskIcon').textContent = icons[data.type] || 'üì¶';
                
                // Update overview
                document.getElementById('celeryTaskId').textContent = data.celery_task_id;
                document.getElementById('taskType').textContent = data.type;
                
                // Load platform name
                if (data.platform_id) {
                    try {
                        const platformResp = await fetch(`/api/platforms/${data.platform_id}`);
                        if (platformResp.ok) {
                            const platform = await platformResp.json();
                            document.getElementById('platformName').innerHTML = `<a href="/platforms" style="color: var(--accent-primary);">${platform.name}</a>`;
                        } else {
                            document.getElementById('platformName').textContent = data.platform_id;
                        }
                    } catch {
                        document.getElementById('platformName').textContent = data.platform_id || '‚Äî';
                    }
                } else {
                    document.getElementById('platformName').textContent = '‚Äî';
                }
                
                document.getElementById('startedAt').textContent = data.started_at ? new Date(data.started_at).toLocaleString() : '‚Äî';
                document.getElementById('finishedAt').textContent = data.finished_at ? new Date(data.finished_at).toLocaleString() : '‚Äî';
                
                // Show metadata if present
                if (data.task_metadata && Object.keys(data.task_metadata).length > 0) {
                    document.getElementById('metadataCard').style.display = 'block';
                    document.getElementById('metadataContent').textContent = JSON.stringify(data.task_metadata, null, 2);
                }
                
                // Show output if present
                if (data.stdout || data.stderr) {
                    document.getElementById('outputCard').style.display = 'block';
                    
                    const stdoutEl = document.getElementById('stdoutContent');
                    if (data.stdout && data.stdout.trim()) {
                        stdoutEl.textContent = data.stdout;
                        stdoutEl.classList.remove('empty');
                    }
                    
                    const stderrEl = document.getElementById('stderrContent');
                    if (data.stderr && data.stderr.trim()) {
                        stderrEl.textContent = data.stderr;
                        stderrEl.classList.remove('empty');
                    }
                }
                
                // Show error if present
                if (data.error_message) {
                    document.getElementById('errorCard').style.display = 'block';
                    document.getElementById('errorContent').textContent = data.error_message;
                }
                
            } catch (err) {
                document.getElementById('statusBadge').textContent = 'ERROR';
                document.getElementById('statusBadge').className = 'status-chip failed';
                alert('Failed to load job details: ' + err.message);
            }
        }
        
        loadJobDetails();
    </script>
</body>
</html>
