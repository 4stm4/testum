{% extends "layout.html" %}
{% set active_page = 'jobs' %}

{% block title %}Jobs - Task Runs{% endblock %}

{% block extra_styles %}
    <style>
        .jobs-toolbar {
            margin-bottom: 24px;
        }

        .jobs-toolbar .filters-inline select {
            min-width: 140px;
        }

        .job-type {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .job-type.deploy {
            background: color-mix(in srgb, var(--md-tertiary) 18%, transparent);
            color: var(--md-tertiary);
        }

        .job-type.run_command {
            background: color-mix(in srgb, var(--md-primary) 18%, transparent);
            color: var(--md-primary);
        }

        .jobs-table .material-symbols-rounded {
            font-size: 20px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <div>
            <h1 class="page-title">
                <span class="material-symbols-rounded" aria-hidden="true">assignment</span>
                <span>Jobs</span>
            </h1>
            <p class="page-subtitle">Track execution history and live status for your automation jobs.</p>
        </div>
        <div class="page-actions">
            <button id="refreshBtn" class="btn btn-secondary">
                <span class="material-symbols-rounded" aria-hidden="true">refresh</span>
                <span>Refresh</span>
            </button>
        </div>
    </div>

    <div class="card table-card">
        <div class="card-header jobs-toolbar">
            <div class="filters-inline">
                <select id="filterStatus">
                    <option value="">Status: All</option>
                    <option value="pending">Pending</option>
                    <option value="running">Running</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                </select>
                <select id="filterType">
                    <option value="">Type: All</option>
                    <option value="deploy">Deploy</option>
                    <option value="run_command">Run Command</option>
                </select>
            </div>
        </div>
        <div class="table-wrapper">
            <table id="tasksTable" class="data-table jobs-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Celery ID</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Platform</th>
                        <th>Started</th>
                        <th>Finished</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="tasksBody">
                    <tr><td colspan="8" class="table-empty-state">Loading tasks…</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div class="pagination">
        <button id="prevPage" disabled>Prev</button>
        <button id="nextPage" disabled>Next</button>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        let offset = 0;
        const limit = 50;

        async function loadTasks() {
            const status = document.getElementById('filterStatus').value;
            const type = document.getElementById('filterType').value;
            let url = `/api/tasks/?limit=${limit}&offset=${offset}`;
            if (status) url += `&status=${encodeURIComponent(status)}`;
            if (type) url += `&type=${encodeURIComponent(type)}`;
            const bodyEl = document.getElementById('tasksBody');
            bodyEl.innerHTML = `<tr><td colspan="8" class="table-empty-state">Loading tasks…</td></tr>`;
            try {
                const resp = await fetch(url);
                if (!resp.ok) {
                    bodyEl.innerHTML = `<tr><td colspan="8" class="table-empty-state">Failed to load tasks</td></tr>`;
                    return;
                }
                const data = await resp.json();
                if (data.length === 0) {
                    bodyEl.innerHTML = `<tr><td colspan="8" class="table-empty-state">No tasks found</td></tr>`;
                } else {
                    bodyEl.innerHTML = data.map(renderRow).join('');
                }
                document.getElementById('prevPage').disabled = offset === 0;
                document.getElementById('nextPage').disabled = data.length < limit;
            } catch (e) {
                bodyEl.innerHTML = `<tr><td colspan="8" class="table-empty-state">Error: ${e.message}</td></tr>`;
            }
        }

        function renderRow(t) {
            const started = t.started_at ? new Date(t.started_at).toLocaleString() : '—';
            const finished = t.finished_at ? new Date(t.finished_at).toLocaleString() : '—';
            const shortId = t.id.substring(0, 8);
            const typeLabel = t.type.replace('_', ' ');
            return `<tr>
                <td><a href="/jobs/${t.celery_task_id}" class="task-link" title="${t.id}">${shortId}…</a></td>
                <td style="max-width:180px; overflow:hidden; text-overflow:ellipsis;" title="${t.celery_task_id}"><code>${t.celery_task_id}</code></td>
                <td><span class="chip job-type ${t.type}">${typeLabel}</span></td>
                <td><span class="status-chip ${t.status}">${t.status.toUpperCase()}</span></td>
                <td>${t.platform_name ? `<span class="platform-link" title="${t.platform_id}">${t.platform_name}</span>` : '—'}</td>
                <td>${started}</td>
                <td>${finished}</td>
                <td>
                    <div class="table-actions">
                        <a class="btn btn-ghost" href="/jobs/${t.celery_task_id}" title="View Details">
                            <span class="material-symbols-rounded" aria-hidden="true">description</span>
                            <span>Details</span>
                        </a>
                        <a class="btn btn-ghost" href="/tasks/${t.celery_task_id}" target="_blank" title="Live Monitor">
                            <span class="material-symbols-rounded" aria-hidden="true">monitor_heart</span>
                            <span>Monitor</span>
                        </a>
                    </div>
                </td>
            </tr>`;
        }

        document.getElementById('refreshBtn').addEventListener('click', () => { loadTasks(); });
        document.getElementById('filterStatus').addEventListener('change', () => { offset = 0; loadTasks(); });
        document.getElementById('filterType').addEventListener('change', () => { offset = 0; loadTasks(); });
        document.getElementById('prevPage').addEventListener('click', () => { if (offset >= limit) { offset -= limit; loadTasks(); } });
        document.getElementById('nextPage').addEventListener('click', () => { offset += limit; loadTasks(); });

        loadTasks();
    </script>
{% endblock %}
