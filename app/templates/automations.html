{% extends "layout.html" %}
{% set active_page = 'automations' %}

{% block title %}Automation Hub - Testum{% endblock %}

{% block extra_styles %}
    <style>
        .page-grid {
            display: grid;
            grid-template-columns: minmax(320px, 420px) 1fr;
            gap: 24px;
        }

        .page-grid-single {
            grid-template-columns: 1fr;
        }

        .form-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .form-card h2 {
            font-size: 1.4em;
            margin-bottom: 6px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-field label {
            font-size: 0.85em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .form-field input,
        .form-field select,
        .form-field textarea {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 12px;
            font-size: 0.9em;
        }

        .form-field textarea {
            min-height: 90px;
            resize: vertical;
        }

        .form-helper {
            font-size: 0.75em;
            color: var(--text-tertiary);
        }

        .switch-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 10px 12px;
        }

        .switch-row span {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .actions button {
            border: none;
            border-radius: 6px;
            padding: 10px 16px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .actions .primary {
            background: var(--accent-primary);
            color: #fff;
        }

        .actions .ghost {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .jobs-list {
            display: grid;
            gap: 20px;
        }

        .job-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 22px;
            display: grid;
            gap: 16px;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
        }

        .job-meta {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            font-size: 0.75em;
            color: var(--text-tertiary);
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bg-tertiary);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 0.75em;
        }

        .tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .feature-highlights {
            display: grid;
            gap: 12px;
        }

        .feature-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
        }

        .feature-card h3 {
            font-size: 1em;
            margin-bottom: 6px;
        }

        .feature-card p {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 30px;
            color: var(--text-secondary);
            border: 1px dashed var(--border-color);
            border-radius: 12px;
        }

        .target-list {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .target-list span {
            font-size: 0.8em;
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 6px;
        }

        @media (max-width: 1200px) {
            .page-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="page-header">
        <h1 class="page-title">‚öôÔ∏è Automation Hub</h1>
        <p class="page-subtitle">–ü–ª–∞–Ω–∏—Ä—É–π—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –∏ —Å–∫—Ä–∏–ø—Ç–æ–≤ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –∏–ª–∏ –ø–æ —Å–æ–±—ã—Ç–∏—è–º</p>
    </div>

    <div id="automationsLayout" class="page-grid">
        <section class="form-card">
            <div>
                <h2>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</h2>
                <p class="form-helper">–û–ø–∏—à–∏—Ç–µ runbook: –≤—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç, —É–∫–∞–∂–∏—Ç–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –∏ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã-–º–∏—à–µ–Ω–∏.</p>
            </div>

            <div class="form-field">
                <label for="jobName">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input id="jobName" placeholder="Nightly security baseline" />
            </div>

            <div class="form-field">
                <label for="jobDescription">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                <textarea id="jobDescription" placeholder="–ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è? –ö–∞–∫–∏–µ –æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?" ></textarea>
            </div>

            <div class="form-field">
                <label>–¢–∏–ø –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
                <div class="switch-row">
                    <span>–ö–æ–º–∞–Ω–¥–∞ (shell)</span>
                    <input type="radio" name="executionType" value="command" checked />
                </div>
                <div class="switch-row">
                    <span>–°–∫—Ä–∏–ø—Ç –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</span>
                    <input type="radio" name="executionType" value="script" />
                </div>
            </div>

            <div id="commandField" class="form-field">
                <label for="jobCommand">–ö–æ–º–∞–Ω–¥–∞ / entrypoint</label>
                <textarea id="jobCommand" placeholder="#!/bin/bash
apt update && apt upgrade -y"></textarea>
                <p class="form-helper">–ö–æ–º–∞–Ω–¥–∞ –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ö–æ—Å—Ç–∞—Ö —á–µ—Ä–µ–∑ SSH.</p>
            </div>

            <div id="scriptField" class="form-field" style="display:none;">
                <label for="jobScript">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç</label>
                <select id="jobScript"></select>
                <p class="form-helper">–°–∫—Ä–∏–ø—Ç—ã –±–µ—Ä—É—Ç—Å—è –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ <strong>Scripts</strong>.</p>
            </div>

            <div class="form-field">
                <label for="jobTrigger">–¢—Ä–∏–≥–≥–µ—Ä</label>
                <select id="jobTrigger">
                    <option value="manual">Manual run</option>
                    <option value="cron">Cron —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</option>
                    <option value="github_push">GitHub push</option>
                    <option value="webhook">–í—Ö–æ–¥—è—â–∏–π –≤–µ–±—Ö—É–∫</option>
                </select>
            </div>

            <div id="cronField" class="form-field" style="display:none;">
                <label for="jobCron">Cron –≤—ã—Ä–∞–∂–µ–Ω–∏–µ</label>
                <input id="jobCron" placeholder="0 3 * * *" />
                <p class="form-helper">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç cron. –ü—Ä–∏–º–µ—Ä: <code>0 3 * * 1-5</code> ‚Äî –±—É–¥–Ω–∏, 03:00.</p>
            </div>

            <div id="githubFields" style="display:none;" class="form-field">
                <label for="jobRepo">GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π</label>
                <input id="jobRepo" placeholder="https://github.com/org/repo" />
                <label for="jobBranch">–í–µ—Ç–∫–∞ / ref</label>
                <input id="jobBranch" placeholder="main" />
                <p class="form-helper">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≤–µ—Ç–∫–µ. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä <code>path:deploy/</code> –≤ —Ç–µ–≥–∞—Ö.</p>
            </div>

            <div id="webhookField" style="display:none;" class="form-field">
                <label for="jobSecret">–°–µ–∫—Ä–µ—Ç –≤–µ–±—Ö—É–∫–∞</label>
                <div style="display:flex; gap:8px;">
                    <input id="jobSecret" placeholder="auto-generated" />
                    <button id="generateSecret" type="button" class="actions ghost" style="padding: 0 14px;">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <p class="form-helper">–¢–æ–∫–µ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è HMAC SHA-256.</p>
            </div>

            <div class="switch-row">
                <span>–ó–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö</span>
                <input type="checkbox" id="jobRunAll" />
            </div>

            <div id="platformField" class="form-field">
                <label for="jobPlatforms">–¶–µ–ª–µ–≤—ã–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</label>
                <select id="jobPlatforms" multiple size="5"></select>
                <p class="form-helper">–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ö–æ—Å—Ç–æ–≤. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –¥–æ 50 —Ö–æ—Å—Ç–æ–≤ –∑–∞ –∑–∞–ø—É—Å–∫.</p>
            </div>

            <div class="form-field">
                <label for="jobEnv">–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (KEY=VALUE)</label>
                <textarea id="jobEnv" placeholder="IMAGE=registry.example.com/app:latest
DEPLOY_ENV=staging"></textarea>
            </div>

            <div class="form-field">
                <label for="jobNotifications">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                <input id="jobNotifications" placeholder="devops@example.com, incident@example.com" />
                <p class="form-helper">–ü–æ—á—Ç–æ–≤—ã–µ –∞–¥—Ä–µ—Å–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. Slack/webhook –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ.</p>
            </div>

            <div class="form-field">
                <label for="jobTags">–¢–µ–≥–∏</label>
                <input id="jobTags" placeholder="security, nightly" />
            </div>

            <div class="switch-row">
                <span>–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º</span>
                <input type="checkbox" id="jobApproval" />
            </div>

            <div class="form-field">
                <label for="jobTimeout">–¢–∞–π–º–∞—É—Ç (—Å–µ–∫—É–Ω–¥—ã)</label>
                <input id="jobTimeout" type="number" min="60" max="86400" value="900" />
            </div>

            <div class="form-field">
                <label for="jobRetries">–ü–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ</label>
                <input id="jobRetries" type="number" min="0" max="10" value="1" />
            </div>

            <div class="form-field">
                <label for="jobRetryDelay">–ü–∞—É–∑–∞ –º–µ–∂–¥—É –ø–æ–≤—Ç–æ—Ä–∞–º–∏ (—Å–µ–∫—É–Ω–¥—ã)</label>
                <input id="jobRetryDelay" type="number" min="0" max="3600" value="120" />
            </div>

            <div class="form-field">
                <label for="jobConcurrency">–õ–∏–º–∏—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—É—Å–∫–æ–≤</label>
                <input id="jobConcurrency" type="number" min="1" max="50" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3" />
            </div>

            <div class="form-field">
                <label for="jobNotes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è</label>
                <textarea id="jobNotes" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã, —á–µ–∫–∞–π—Ç–µ dashboards"></textarea>
            </div>

            <div class="actions">
                <button id="createJob" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–¥–∞—á—É</button>
                <button id="resetForm" class="ghost" type="button">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
            </div>
        </section>

        <section class="jobs-list" id="jobsList">
            <div class="feature-card">
                <h3>–ö–∞–∫ –¥–µ–ª–∞—é—Ç –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã</h3>
                <p>–ú—ã –ø–æ–¥—Å–º–æ—Ç—Ä–µ–ª–∏ –ª—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏ —É GitHub Actions, Jenkins, GitLab CI –∏ Ansible AWX –∏ —Å–æ–±—Ä–∞–ª–∏ must-have –∏–¥–µ–∏:</p>
                <ul style="margin-top: 10px; color: var(--text-secondary); font-size: 0.85em; display: grid; gap: 6px;">
                    <li>‚úÖ Approval gates –ø–µ—Ä–µ–¥ –∫—Ä–∏—Ç–∏—á–Ω—ã–º–∏ –¥–µ–ø–ª–æ—è–º–∏ –∏ –∑–∞–ø—É—Å–∫–æ–º –≤ –ø—Ä–æ–¥–µ.</li>
                    <li>‚úÖ Smart notifications: e-mail, Slack, webhook + –æ—Ç—á—ë—Ç—ã –≤ Confluence.</li>
                    <li>‚úÖ Drift detection –∏ post-run –ø—Ä–æ–≤–µ—Ä–∫–∏, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å, —á—Ç–æ —Ö–æ—Å—Ç –æ—Å—Ç–∞–ª—Å—è –≤ —Ü–µ–ª–µ–≤–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.</li>
                    <li>‚úÖ Source control awareness ‚Äî –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –≤–µ—Ç–∫–∞—Ö, —Ç–µ–≥–∞—Ö, PR.</li>
                    <li>‚úÖ Policy-as-code: —Ç–µ–≥–∏, –≤–ª–∞–¥–µ–ª—å—Ü—ã, SLO, SLA –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º.</li>
                </ul>
            </div>
        </section>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const jobsListEl = document.getElementById('jobsList');
        const runAllCheckbox = document.getElementById('jobRunAll');
        const platformsSelect = document.getElementById('jobPlatforms');
        const triggerSelect = document.getElementById('jobTrigger');
        const executionRadios = document.querySelectorAll('input[name="executionType"]');
        const commandField = document.getElementById('commandField');
        const scriptField = document.getElementById('scriptField');
        const cronField = document.getElementById('cronField');
        const githubFields = document.getElementById('githubFields');
        const webhookField = document.getElementById('webhookField');

        async function loadPlatforms() {
            const response = await fetch('/api/platforms/');
            if (!response.ok) return;
            const platforms = await response.json();
            platformsSelect.innerHTML = platforms.map(p => `<option value="${p.id}">${p.name} (${p.host})</option>`).join('');
        }

        async function loadScripts() {
            const response = await fetch('/api/scripts/');
            if (!response.ok) return;
            const scripts = await response.json();
            if (scripts.length === 0) {
                document.getElementById('jobScript').innerHTML = '<option value="">–°–∫—Ä–∏–ø—Ç–æ–≤ –Ω–µ—Ç</option>';
                return;
            }
            document.getElementById('jobScript').innerHTML = scripts.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        async function loadJobs() {
            try {
                const response = await fetch('/api/automations/');
                if (!response.ok) {
                    jobsListEl.innerHTML = `<div class="empty-state">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á–∏</div>`;
                    return;
                }
                const jobs = await response.json();
                if (jobs.length === 0) {
                    jobsListEl.innerHTML = `<div class="empty-state">–ó–∞–¥–∞—á–∏ –ø–æ–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é ‚Äî –∏ Testum –∑–∞–ø–æ–º–Ω–∏—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.</div>`;
                    return;
                }
                jobsListEl.innerHTML = jobs.map(renderJobCard).join('');
            } catch (err) {
                console.error(err);
                jobsListEl.innerHTML = `<div class="empty-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message}</div>`;
            }
        }

        function renderJobCard(job) {
            const triggerCopy = {
                manual: 'Manual trigger',
                cron: `Cron: ${job.cron_expression}`,
                github_push: 'GitHub push',
                webhook: 'Incoming webhook'
            };
            const targets = job.run_on_all_platforms ? '<span>–í—Å–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã</span>' : job.targets.map(t => `<span>${t.platform_name || t.platform_id}</span>`).join('');
            const tags = job.tags && job.tags.length ? job.tags.map(tag => `<span class="chip">#${tag}</span>`).join('') : '<span class="form-helper">–ë–µ–∑ —Ç–µ–≥–æ–≤</span>';
            const commandPreview = job.execution_type === 'command' ? `<pre style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; white-space: pre-wrap;">${(job.command || '').slice(0, 400)}</pre>` : `<div class="form-helper">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç: ${job.script_id}</div>`;
            const statusChip = job.is_enabled ? '<span class="chip" style="background: rgba(166,227,161,0.1); color: #a6e3a1;">ENABLED</span>' : '<span class="chip" style="background: rgba(243,139,168,0.1); color: #f38ba8;">PAUSED</span>';

            return `
                <article class="job-card" data-id="${job.id}">
                    <div class="job-header">
                        <div>
                            <h2 style="font-size: 1.2em;">${job.name}</h2>
                            <p style="color: var(--text-secondary); font-size: 0.9em;">${job.description || '–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ'}</p>
                        </div>
                        <div class="job-meta">
                            ${statusChip}
                            <span class="chip">${job.execution_type === 'command' ? 'CLI' : 'Script'}</span>
                            <span class="chip">${triggerCopy[job.trigger_type] || job.trigger_type}</span>
                        </div>
                    </div>
                    <div>${commandPreview}</div>
                    <div>
                        <strong style="font-size: 0.85em;">–¶–µ–ª–∏:</strong>
                        <div class="target-list">${targets || '<span>–ù–µ—Ç –ø–ª–∞—Ç—Ñ–æ—Ä–º</span>'}</div>
                    </div>
                    <div>
                        <strong style="font-size: 0.85em;">–¢–µ–≥–∏:</strong>
                        <div class="tags">${tags}</div>
                    </div>
                    <div style="display:flex; gap:12px; flex-wrap:wrap;">
                        <button class="ghost" data-action="toggle">${job.is_enabled ? '‚è∏Ô∏è –ü–∞—É–∑–∞' : '‚ñ∂Ô∏è –í–∫–ª—é—á–∏—Ç—å'}</button>
                        <button class="ghost" data-action="delete" style="color:#f38ba8; border-color:#f38ba8;">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                        <span style="font-size:0.75em; color:var(--text-tertiary);">–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—É—Å–∫: ${job.last_run_at ? new Date(job.last_run_at).toLocaleString() : '‚Äî'} | –°–ª–µ–¥—É—é—â–∏–π: ${job.next_run_at ? new Date(job.next_run_at).toLocaleString() : '–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ TBD'}</span>
                    </div>
                </article>
            `;
        }

        jobsListEl.addEventListener('click', async (event) => {
            const action = event.target.dataset.action;
            if (!action) return;
            const card = event.target.closest('.job-card');
            const jobId = card?.dataset.id;
            if (!jobId) return;

            if (action === 'delete') {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—é?')) return;
                const response = await fetch(`/api/automations/${jobId}`, { method: 'DELETE' });
                if (response.ok) {
                    loadJobs();
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É');
                }
                return;
            }

            if (action === 'toggle') {
                const isEnabled = event.target.textContent.includes('–ü–∞—É–∑–∞');
                const payload = { is_enabled: !isEnabled };
                const response = await fetch(`/api/automations/${jobId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (response.ok) {
                    loadJobs();
                } else {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É');
                }
            }
        });

        function parseEnv(input) {
            const lines = input.split('\n');
            const result = {};
            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed || trimmed.startsWith('#')) continue;
                const [key, ...rest] = trimmed.split('=');
                if (!key || rest.length === 0) continue;
                result[key.trim()] = rest.join('=').trim();
            }
            return result;
        }

        function parseList(input) {
            if (!input) return [];
            return input.split(',').map(item => item.trim()).filter(Boolean);
        }

        function resetForm() {
            document.getElementById('jobName').value = '';
            document.getElementById('jobDescription').value = '';
            document.getElementById('jobCommand').value = '';
            document.getElementById('jobScript').selectedIndex = 0;
            triggerSelect.value = 'manual';
            document.getElementById('jobCron').value = '';
            document.getElementById('jobRepo').value = '';
            document.getElementById('jobBranch').value = '';
            document.getElementById('jobSecret').value = '';
            runAllCheckbox.checked = false;
            Array.from(platformsSelect.options).forEach(opt => opt.selected = false);
            document.getElementById('jobEnv').value = '';
            document.getElementById('jobNotifications').value = '';
            document.getElementById('jobTags').value = '';
            document.getElementById('jobApproval').checked = false;
            document.getElementById('jobTimeout').value = 900;
            document.getElementById('jobRetries').value = 1;
            document.getElementById('jobRetryDelay').value = 120;
            document.getElementById('jobConcurrency').value = '';
            document.getElementById('jobNotes').value = '';
            document.querySelector('input[name="executionType"][value="command"]').checked = true;
            updateExecutionFields();
            updateTriggerFields();
        }

        function updateExecutionFields() {
            const value = document.querySelector('input[name="executionType"]:checked').value;
            if (value === 'command') {
                commandField.style.display = 'flex';
                scriptField.style.display = 'none';
            } else {
                commandField.style.display = 'none';
                scriptField.style.display = 'flex';
            }
        }

        function updateTriggerFields() {
            const value = triggerSelect.value;
            cronField.style.display = value === 'cron' ? 'flex' : 'none';
            githubFields.style.display = value === 'github_push' ? 'flex' : 'none';
            webhookField.style.display = value === 'webhook' ? 'flex' : 'none';
        }

        document.getElementById('resetForm').addEventListener('click', () => resetForm());
        executionRadios.forEach(radio => radio.addEventListener('change', updateExecutionFields));
        triggerSelect.addEventListener('change', updateTriggerFields);
        runAllCheckbox.addEventListener('change', () => {
            platformsSelect.disabled = runAllCheckbox.checked;
        });
        document.getElementById('generateSecret').addEventListener('click', () => {
            const random = crypto.getRandomValues(new Uint8Array(24)).reduce((acc, val) => acc + val.toString(16).padStart(2, '0'), '');
            document.getElementById('jobSecret').value = random.slice(0, 48);
        });

        document.getElementById('createJob').addEventListener('click', async (event) => {
            event.preventDefault();
            const name = document.getElementById('jobName').value.trim();
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏');
                return;
            }

            const executionType = document.querySelector('input[name="executionType"]:checked').value;
            const triggerType = triggerSelect.value;
            const commandValue = document.getElementById('jobCommand').value.trim();
            const scriptValue = document.getElementById('jobScript').value;
            const cronValue = document.getElementById('jobCron').value.trim();
            const secretValue = document.getElementById('jobSecret').value.trim();

            if (executionType === 'command' && !commandValue) {
                alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è');
                return;
            }
            if (executionType === 'script' && !scriptValue) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏');
                return;
            }
            if (triggerType === 'cron' && !cronValue) {
                alert('–î–æ–±–∞–≤—å—Ç–µ cron-–≤—ã—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }
            if (triggerType === 'webhook' && !secretValue) {
                alert('–£–∫–∞–∂–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç –≤–µ–±—Ö—É–∫–∞');
                return;
            }
            if (!runAllCheckbox.checked && Array.from(platformsSelect.selectedOptions).length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–ª–∞—Ç—Ñ–æ—Ä–º—É –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç–µ –∑–∞–ø—É—Å–∫ –Ω–∞ –≤—Å–µ—Ö.');
                return;
            }

            const payload = {
                name,
                description: document.getElementById('jobDescription').value.trim() || null,
                execution_type: executionType,
                command: executionType === 'command' ? commandValue : null,
                script_id: executionType === 'script' ? scriptValue || null : null,
                trigger_type: triggerType,
                cron_expression: triggerType === 'cron' ? cronValue : null,
                repository_url: triggerType === 'github_push' ? document.getElementById('jobRepo').value.trim() : null,
                repository_branch: triggerType === 'github_push' ? document.getElementById('jobBranch').value.trim() : null,
                webhook_secret: triggerType === 'webhook' ? secretValue : null,
                run_on_all_platforms: runAllCheckbox.checked,
                target_platform_ids: runAllCheckbox.checked ? [] : Array.from(platformsSelect.selectedOptions).map(opt => opt.value),
                environment: parseEnv(document.getElementById('jobEnv').value),
                notification_settings: { emails: parseList(document.getElementById('jobNotifications').value) },
                tags: parseList(document.getElementById('jobTags').value),
                require_approval: document.getElementById('jobApproval').checked,
                timeout_seconds: Number(document.getElementById('jobTimeout').value || 900),
                max_retries: Number(document.getElementById('jobRetries').value || 0),
                retry_delay_seconds: Number(document.getElementById('jobRetryDelay').value || 60),
                concurrency_limit: document.getElementById('jobConcurrency').value ? Number(document.getElementById('jobConcurrency').value) : null,
                notes: document.getElementById('jobNotes').value.trim() || null,
                parameters: {
                    drift_detection: true,
                    smoke_tests: true,
                    owner: 'automation-team'
                },
                is_enabled: true
            };

            try {
                const response = await fetch('/api/automations/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É: ${err.error || response.statusText}`);
                    return;
                }
                resetForm();
                loadJobs();
            } catch (error) {
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        });

        loadPlatforms();
        loadScripts();
        loadJobs();
        updateExecutionFields();
        updateTriggerFields();
    </script>
{% endblock %}
