version: '3.8'

# Testum Docker Compose Configuration

    entrypoint: ["/bin/bash", "-lc"]
    command: |
      set -Eeuo pipefail
      echo 'Installing system dependencies...'
      apt-get update -qq
      apt-get install -y -qq --no-install-recommends gcc libpq-dev postgresql-client git
      rm -rf /var/lib/apt/lists/*

      echo 'Cloning repository (forcing fresh clone)...'
      cd /tmp
      rm -rf testum
      git clone --depth 1 --branch main https://github.com/4stm4/testum.git testum
      cd testum
      git log -1 --oneline
      rm -rf /app/*
      shopt -s dotglob
      mv * /app/
      cd /app

      echo 'Installing Python packages...'
      VENV_PATH="/app/.venv"
      rm -rf "$VENV_PATH"
      python3 -m venv "$VENV_PATH"
      "$VENV_PATH/bin/python" -m pip install --no-cache-dir --upgrade pip setuptools wheel
      "$VENV_PATH/bin/python" -m pip install --no-cache-dir -r /app/requirements.txt
      "$VENV_PATH/bin/python" -m pip install --no-cache-dir "uvicorn[standard]==0.32.1"
      "$VENV_PATH/bin/python" -m pip install --no-cache-dir "taskiq==0.11.7"

      echo 'Checking installed packages...'
      "$VENV_PATH/bin/python" - <<'PY'
      import importlib
      missing = []
      for module_name in ("uvicorn", "taskiq"):
          try:
              module = importlib.import_module(module_name)
              print(f"{module_name} available at {module.__file__}")
          except ImportError:
              missing.append(module_name)
      if missing:
          raise SystemExit(f"Missing modules after installation: {', '.join(missing)}")
      PY

      echo 'Waiting for database...'
      until pg_isready -h db -p 5432 -U postgres; do
        echo 'Database unavailable - sleeping'
        sleep 2
      done

      echo 'Running migrations...'
      "$VENV_PATH/bin/alembic" upgrade head

      echo 'Starting Taskiq worker in background...'
      "$VENV_PATH/bin/python" -m taskiq worker app.tasks_new:broker --fs-discover > /tmp/taskiq.log 2>&1 &
      TASKIQ_PID=$!
      echo "Taskiq worker started with PID: ${TASKIQ_PID}"
      trap "if [ -n \"$TASKIQ_PID\" ]; then kill $TASKIQ_PID 2>/dev/null; fi" EXIT INT TERM

      echo 'Starting application...'
      exec "$VENV_PATH/bin/python" -m uvicorn app.main:app --host 0.0.0.0 --port 8000
                if(r.ok){
                  t.textContent='Application ready! Redirecting...';
                  setTimeout(()=>{ window.location.href=proto+'//'+host+':8001/login'; }, 800);
                } else {
                  setTimeout(poll, 2000);
                }
              })
              .catch(err=>{
                t.textContent='Waiting for app on '+host+':8001 ('+err+')';
                setTimeout(poll, 2000);
              });
          }
          setTimeout(poll, 1200);
        </script>
      </body>
      </html>
      EOF
      # Write a simple nginx site config to the conf.d directory (avoid reading config from stdin)
      cat >/etc/nginx/conf.d/testum.conf <<'NGINX_CONF'
      server {
        listen 8000;
        server_name _;
        location / {
          root /usr/share/nginx/html;
          index index.html;
        }
      }
      NGINX_CONF
      # Use exec to replace shell with nginx process so container stays running
      exec nginx -g 'daemon off;'
    networks:
      - testum_network

  db:
    image: postgres:15-alpine
    container_name: testum_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: testum
      POSTGRES_INITDB_ARGS: "--locale=C.UTF-8"
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - testum_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: testum_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9010:9000"
      - "9011:9001"
    networks:
      - testum_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 15s
      timeout: 5s
      retries: 3

  app:
    image: python:3.12-slim
    container_name: testum_app
    restart: unless-stopped
    working_dir: /app
    environment:
      APP_ENV: production
      SECRET_KEY: test-secret-key-change-me-in-production
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin123
      FERNET_KEY: 8KMhgoZ3LqvVNxKz4YHzMNJRCq5YUf3yx8WlBKxuX8k=
      DATABASE_URL: postgresql://postgres:postgres@db:5432/testum
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: testum-artifacts
      MINIO_SECURE: "false"
      SSH_HOST_KEY_POLICY: auto_add
    ports:
      - "8001:8000"
    networks:
      - testum_network
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
    entrypoint: /bin/bash
    command: >
      -c "
      set -e &&
      echo 'Installing system dependencies...' &&
      apt-get update -qq && 
      apt-get install -y -qq --no-install-recommends gcc libpq-dev postgresql-client git && 
      rm -rf /var/lib/apt/lists/* &&
      echo 'Cloning repository (forcing fresh clone)...' &&
      cd /tmp &&
      rm -rf testum &&
      git clone --depth 1 --branch main https://github.com/4stm4/testum.git testum &&
      cd testum &&
      git log -1 --oneline &&
      rm -rf /app/* &&
      mv * /app/ 2>/dev/null || true &&
      mv .* /app/ 2>/dev/null || true &&
      cd /app &&
      echo 'Installing Python packages...' &&
      VENV_PATH="/app/.venv" &&
      rm -rf "$VENV_PATH" &&
      python3 -m venv "$VENV_PATH" &&
      . "$VENV_PATH/bin/activate" &&
      python -m pip install --no-cache-dir --upgrade pip setuptools wheel &&
      python -m pip install --no-cache-dir -r /app/requirements.txt &&
      python -m pip install --no-cache-dir \"uvicorn[standard]==0.32.1\" &&
      python -m pip install --no-cache-dir \"taskiq==0.11.7\" &&
      echo 'Checking installed packages...' &&
      python - <<'PY'
      import importlib
      missing = []
      for module_name in ("uvicorn", "taskiq"):
          try:
              module = importlib.import_module(module_name)
              print(f"{module_name} available at {module.__file__}")
          except ImportError:
              missing.append(module_name)
      if missing:
          raise SystemExit(f"Missing modules after installation: {', '.join(missing)}")
      PY &&
      echo 'Waiting for database...' &&
      until pg_isready -h db -p 5432 -U postgres; do
        echo 'Database unavailable - sleeping';
        sleep 2;
      done &&
      echo 'Running migrations...' &&
      alembic upgrade head &&
      echo 'Starting Taskiq worker in background...' &&
      python -m taskiq worker app.tasks_new:broker --fs-discover > /tmp/taskiq.log 2>&1 &
      TASKIQ_PID=$! &&
      echo \"Taskiq worker started with PID: ${TASKIQ_PID}\" &&
      trap \"if [ -n \\\"$TASKIQ_PID\\\" ]; then kill $TASKIQ_PID 2>/dev/null; fi\" EXIT INT TERM &&
      echo 'Starting application...' &&
      python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
      "

networks:
  testum_network:
    driver: bridge

volumes:
  postgres_data:
  minio_data:
