version: '3.8'

# Testum Docker Compose Configuration

services:
  nginx:
    image: nginx:alpine
    container_name: testum_nginx
    restart: unless-stopped
    ports:
      - "8000:8000"
    entrypoint: ["/bin/sh","-c"]
    command: |
      cat >/usr/share/nginx/html/index.html <<'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Testum - Starting...</title>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400..700,0..1,-50..200" rel="stylesheet">
        <style>
          body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;background:linear-gradient(135deg,#1e1e2e 0%,#2a2a3e 100%);color:#cdd6f4;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:20px}
          .c{text-align:center;max-width:600px;width:100%}
          .ms{font-family:'Material Symbols Rounded';font-weight:400;font-style:normal;display:inline-flex;align-items:center;justify-content:center}
          .l{font-size:64px;margin-bottom:16px;display:flex;align-items:center;justify-content:center}
          h1{color:#89b4fa;margin:0 0 8px}
          .s{color:#a6adc8;margin-bottom:24px}
          .b{background:#181825;border:1px solid #313244;border-radius:12px;padding:24px}
          .p{height:8px;background:#313244;border-radius:4px;overflow:hidden;margin:12px 0 0}
          .f{height:100%;width:60%;background:linear-gradient(90deg,#89b4fa,#7aa2f7);animation:p 2.5s ease-in-out infinite;border-radius:4px}
          @keyframes p{0%{width:30%}50%{width:70%}100%{width:30%}}
          .m{margin-top:12px;color:#6c7086}
        </style>
      </head>
      <body>
        <div class="c">
          <div class="l"><span class="ms" aria-hidden="true">terminal</span></div>
          <h1>Testum</h1>
          <div class="s">Starting application...</div>
          <div class="b">
            <div id="t">Checking service health...</div>
            <div class="p"><div class="f"></div></div>
            <div class="m">This may take 1-2 minutes on first startup</div>
          </div>
        </div>
        <script>
          let n=0;
          const proto=window.location.protocol; // keep same http/https as loader
          const host=window.location.hostname;
          function poll(){
            n++;
            const t=document.getElementById('t');
            t.textContent='Checking app health (try '+n+')...';
            fetch(proto+'//'+host+':8001/health', {cache:'no-store'})
              .then(r=>{
                if(r.ok){
                  t.textContent='Application ready! Redirecting...';
                  setTimeout(()=>{ window.location.href=proto+'//'+host+':8001/login'; }, 800);
                } else {
                  setTimeout(poll, 2000);
                }
              })
              .catch(err=>{
                t.textContent='Waiting for app on '+host+':8001 ('+err+')';
                setTimeout(poll, 2000);
              });
          }
          setTimeout(poll, 1200);
        </script>
      </body>
      </html>
      EOF
      # Write a simple nginx site config to the conf.d directory (avoid reading config from stdin)
      cat >/etc/nginx/conf.d/testum.conf <<'NGINX_CONF'
      server {
        listen 8000;
        server_name _;
        location / {
          root /usr/share/nginx/html;
          index index.html;
        }
      }
      NGINX_CONF
      # Use exec to replace shell with nginx process so container stays running
      exec nginx -g 'daemon off;'
    networks:
      - testum_network

  db:
    image: postgres:15-alpine
    container_name: testum_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: testum
      POSTGRES_INITDB_ARGS: "--locale=C.UTF-8 --lc-collate=C --lc-ctype=C.UTF-8"
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - testum_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        apk add --no-cache musl-locales musl-locales-lang
        exec docker-entrypoint.sh postgres

  minio:
    image: minio/minio:latest
    container_name: testum_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9010:9000"
      - "9011:9001"
    networks:
      - testum_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 15s
      timeout: 5s
      retries: 3

  app:
    image: python:3.12-slim
    container_name: testum_app
    restart: unless-stopped
    working_dir: /app
    environment:
      APP_ENV: production
      SECRET_KEY: test-secret-key-change-me-in-production
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin123
      FERNET_KEY: 8KMhgoZ3LqvVNxKz4YHzMNJRCq5YUf3yx8WlBKxuX8k=
      DATABASE_URL: postgresql://postgres:postgres@db:5432/testum
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: testum-artifacts
      MINIO_SECURE: "false"
      SSH_HOST_KEY_POLICY: auto_add
    ports:
      - "8001:8000"
    networks:
      - testum_network
    depends_on:
      db:
        condition: service_healthy
      minio:
        condition: service_healthy
    command:
      - /bin/bash
      - -c
      - |
        set -e
        echo 'Installing system dependencies...'
        export DEBIAN_FRONTEND=noninteractive
        apt-get update -qq
        apt-get install -y -qq --no-install-recommends gcc libpq-dev postgresql-client git
        rm -rf /var/lib/apt/lists/*
        
        echo 'Cloning repository (forcing fresh clone)...'
        cd /tmp
        rm -rf testum
        git clone --depth 1 --branch main https://github.com/4stm4/testum.git testum
        cd testum
        git log -1 --oneline
        rm -rf /app/*
        mv * /app/ 2>/dev/null || true
        mv .* /app/ 2>/dev/null || true
        cd /app
        
        echo 'Installing Python packages...'
        rm -rf /app/.venv
        python3 -m venv /app/.venv
        . /app/.venv/bin/activate
        python -m pip install --no-cache-dir --upgrade pip setuptools wheel
        python -m pip install --no-cache-dir -r /app/requirements.txt
        
        echo 'Checking installed packages...'
        python -c "import uvicorn, taskiq; from taskiq_pg.asyncpg import AsyncpgBroker; print('All required modules imported successfully')"
        
        echo 'Waiting for database...'
        until pg_isready -h db -p 5432 -U postgres; do
          echo 'Database unavailable - sleeping'
          sleep 2
        done
        
        echo 'Running migrations...'
        alembic upgrade head
        
        echo 'Starting Taskiq worker in background...'
        nohup python -m taskiq worker app.tasks_new:broker --fs-discover > /tmp/taskiq.log 2>&1 &
        TASKIQ_PID=$!
        echo "Taskiq worker started with PID: ${TASKIQ_PID}"
        
        # Wait for worker to initialize
        echo 'Waiting for Taskiq worker to initialize...'
        sleep 3
        
        # Check if worker is still running
        if ! kill -0 $TASKIQ_PID 2>/dev/null; then
          echo "ERROR: Taskiq worker failed to start!"
          echo "=== Worker logs ==="
          cat /tmp/taskiq.log
          exit 1
        fi
        echo "Taskiq worker is running"
        
        # Cleanup on exit
        trap "echo 'Stopping Taskiq worker...'; kill $TASKIQ_PID 2>/dev/null || true" EXIT INT TERM
        
        echo 'Starting application...'
        exec python -m uvicorn app.main:app --host 0.0.0.0 --port 8000

networks:
  testum_network:
    driver: bridge

volumes:
  postgres_data:
  minio_data:
