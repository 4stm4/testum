version: '3.8'

# Testum Docker Compose Configuration
# Ready for Portainer deployment with pre-configured environment variables
# For production: change ADMIN_PASSWORD and optionally regenerate FERNET_KEY

services:
  nginx:
    image: nginx:alpine
    container_name: testum_nginx
    restart: unless-stopped
    ports:
      - "8000:8000"
    entrypoint: ["/bin/sh","-c"]
    command: |
      cat >/usr/share/nginx/html/index.html <<'EOF'
      <!DOCTYPE html>
      <html lang="en">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Testum - Starting...</title>
        <style>
          body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,sans-serif;background:linear-gradient(135deg,#1e1e2e 0%,#2a2a3e 100%);color:#cdd6f4;display:flex;align-items:center;justify-content:center;min-height:100vh;margin:0;padding:20px}
          .c{text-align:center;max-width:600px;width:100%}
          .l{font-size:64px;margin-bottom:16px}
          h1{color:#89b4fa;margin:0 0 8px}
          .s{color:#a6adc8;margin-bottom:24px}
          .b{background:#181825;border:1px solid #313244;border-radius:12px;padding:24px}
          .p{height:8px;background:#313244;border-radius:4px;overflow:hidden;margin:12px 0 0}
          .f{height:100%;width:60%;background:linear-gradient(90deg,#89b4fa,#7aa2f7);animation:p 2.5s ease-in-out infinite;border-radius:4px}
          @keyframes p{0%{width:30%}50%{width:70%}100%{width:30%}}
          .m{margin-top:12px;color:#6c7086}
        </style>
      </head>
      <body>
        <div class="c">
          <div class="l">üîê</div>
          <h1>Testum</h1>
          <div class="s">Starting application...</div>
          <div class="b">
            <div id="t">Checking service health...</div>
            <div class="p"><div class="f"></div></div>
            <div class="m">This may take 1-2 minutes on first startup</div>
          </div>
        </div>
        <script>
          let n=0;
          const proto=window.location.protocol; // keep same http/https as loader
          const host=window.location.hostname;
          function poll(){
            n++;
            const t=document.getElementById('t');
            t.textContent='Checking app health (try '+n+')...';
            fetch(proto+'//'+host+':8001/health', {cache:'no-store'})
              .then(r=>{
                if(r.ok){
                  t.textContent='Application ready! Redirecting...';
                  setTimeout(()=>{ window.location.href=proto+'//'+host+':8001/login'; }, 800);
                } else {
                  setTimeout(poll, 2000);
                }
              })
              .catch(err=>{
                t.textContent='Waiting for app on '+host+':8001 ('+err+')';
                setTimeout(poll, 2000);
              });
          }
          setTimeout(poll, 1200);
        </script>
      </body>
      </html>
      EOF
      # Write a simple nginx site config to the conf.d directory (avoid reading config from stdin)
      cat >/etc/nginx/conf.d/testum.conf <<'NGINX_CONF'
      server {
        listen 8000;
        server_name _;
        location / {
          root /usr/share/nginx/html;
          index index.html;
        }
      }
      NGINX_CONF
      # Use exec to replace shell with nginx process so container stays running
      exec nginx -g 'daemon off;'
    networks:
      - testum_network

  db:
    image: postgres:15-alpine
    container_name: testum_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: testum
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - testum_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: testum_redis
    restart: unless-stopped
    networks:
      - testum_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: testum_minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    volumes:
      - minio_data:/data
    ports:
      - "9010:9000"
      - "9011:9001"
    networks:
      - testum_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 15s
      timeout: 5s
      retries: 3

  app:
    build:
      context: .
    image: testum_app:latest
    container_name: testum_app
    restart: unless-stopped
    environment:
      APP_ENV: production
      SECRET_KEY: test-secret-key-change-me-in-production
      ADMIN_USERNAME: admin
      ADMIN_PASSWORD: admin123
      FERNET_KEY: 8KMhgoZ3LqvVNxKz4YHzMNJRCq5YUf3yx8WlBKxuX8k=
      DATABASE_URL: postgresql://postgres:postgres@db:5432/testum
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: testum-artifacts
      MINIO_SECURE: "false"
      SSH_HOST_KEY_POLICY: auto_add
    ports:
      - "8001:8000"
    networks:
      - testum_network
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      minio:
        condition: service_healthy

  celery_worker:
    image: testum_app:latest
    container_name: testum_celery
    restart: unless-stopped
    environment:
      APP_ENV: production
      FERNET_KEY: 8KMhgoZ3LqvVNxKz4YHzMNJRCq5YUf3yx8WlBKxuX8k=
      DATABASE_URL: postgresql://postgres:postgres@db:5432/testum
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      MINIO_ENDPOINT: minio:9000
      MINIO_ACCESS_KEY: minioadmin
      MINIO_SECRET_KEY: minioadmin
      MINIO_BUCKET: testum-artifacts
      MINIO_SECURE: "false"
      SSH_HOST_KEY_POLICY: auto_add
    networks:
      - testum_network
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      RUN_MIGRATIONS: "0"
    command: ["celery", "-A", "app.celery_app", "worker", "--loglevel=info", "--concurrency=2"]

networks:
  testum_network:
    driver: bridge

volumes:
  postgres_data:
  minio_data:
